!function(a){function b(b,c){var d;return a.Notification?d=new a.Notification(b,{icon:r(c.icon)?c.icon:c.icon.x32,body:c.body||n,tag:c.tag||n}):a.webkitNotifications?(d=a.webkitNotifications.createNotification(c.icon,b,c.body),d.show()):navigator.mozNotification?(d=navigator.mozNotification.createNotification(b,c.body,c.icon),d.show()):a.external&&a.external.msIsSiteMode()&&(a.external.msSiteModeClearIconOverlay(),a.external.msSiteModeSetIconOverlay(r(c.icon)?c.icon:c.icon.x16,b),a.external.msSiteModeActivate(),d={ieVerification:p+1}),d}function c(b){return{webNotification:b,close:function(){b&&(b.close?b.close():b.cancel?b.cancel():a.external&&a.external.msIsSiteMode()&&b.ieVerification===p&&a.external.msSiteModeClearIconOverlay())}}}function d(b){if(o){var c=q(b)?b:u;a.webkitNotifications&&a.webkitNotifications.checkPermission?a.webkitNotifications.requestPermission(c):a.Notification&&a.Notification.requestPermission&&a.Notification.requestPermission(c)}}function e(){var b;if(o)return a.Notification&&a.Notification.permissionLevel?b=a.Notification.permissionLevel():a.webkitNotifications&&a.webkitNotifications.checkPermission?b=k[a.webkitNotifications.checkPermission()]:a.Notification&&a.Notification.permission?b=a.Notification.permission:navigator.mozNotification?b=i:a.external&&void 0!==a.external.msIsSiteMode()&&(b=a.external.msIsSiteMode()?i:h),b}function f(a){return a&&s(a)&&t(v,a),v}function g(d,f){var g,h;return o&&r(d)&&f&&(r(f.icon)||s(f.icon))&&e()===i&&(g=b(d,f)),h=c(g),v.autoClose&&g&&!g.ieVerification&&g.addEventListener&&g.addEventListener("show",function(){var b=h;a.setTimeout(function(){b.close()},v.autoClose)}),h}var h="default",i="granted",j="denied",k=[i,h,j],l={pageVisibility:!1,autoClose:0},m={},n="",o=function(){var b=!1;try{b=!!(a.Notification||a.webkitNotifications||navigator.mozNotification||a.external&&void 0!==a.external.msIsSiteMode())}catch(c){}return b}(),p=Math.floor(10*Math.random()+1),q=function(a){return a&&a.constructor===Function},r=function(a){return a&&a.constructor===String},s=function(a){return a&&a.constructor===Object},t=function(a,b){var c,d;for(c in b)d=b[c],c in a&&(a[c]===d||c in m&&m[c]===d)||(a[c]=d);return a},u=function(){},v=l;a.notify={PERMISSION_DEFAULT:h,PERMISSION_GRANTED:i,PERMISSION_DENIED:j,isSupported:o,config:f,createNotification:g,permissionLevel:e,requestPermission:d},q(Object.seal)&&Object.seal(a.notify)}(window),function(a){"use strict";var b=window.angular.module("angular-web-notification",[]);b.factory("webNotification",function(){var b={};b.allowRequest=!0,Object.defineProperty(b,"permissionGranted",{get:function(){var b=a.permissionLevel(),c=!1;return b===a.PERMISSION_GRANTED&&(c=!0),c}});var c=function(){var c=a.isSupported;return c&&(c=b.permissionGranted),c},d=function(b,c){var d=0;c&&c.autoClose&&"number"==typeof c.autoClose&&(d=c.autoClose),a.config({autoClose:d});var e=a.createNotification(b,c);return c.onClick&&e&&e.webNotification&&(e.webNotification.onclick=c.onClick),function(){e.close()}},e=function(a){var b=a.pop(),c=null,d=null;if(2===a.length)c=a[0],d=a[1];else if(1===a.length){var e=a.pop();"string"==typeof e?(c=e,d={}):(c="",d=e)}return c=c||"",d=d||{},{callback:b,title:c,options:d}};return b.showNotification=function(){var f=Array.prototype.slice.call(arguments,0);if(f.length>=1&&f.length<=3){var g=e(f),h=g.callback,i=g.title,j=g.options,k=null;c()?(k=d(i,j),h(null,k)):b.allowRequest?a.requestPermission(function(){c()?(k=d(i,j),h(null,k)):h(new Error("Notifications are not enabled."),null)}):h(new Error("Notifications are not enabled."),null)}},b})}(window.notify),angular.module("myApp",["ngRoute","loginService","restangular","ngCookies","dataFormat","angular-web-notification","ui.bootstrap","socketService"]).config(["$locationProvider","$routeProvider","RestangularProvider",function(a,b,c){a.hashPrefix("!"),c.setBaseUrl("http://115.28.109.109:81/"),b.when("/",{redirectTo:"login"}).when("/chat",{templateUrl:"javascripts/chat/chat.html",controller:"ChatCtrl"}).when("/login",{templateUrl:"javascripts/login/login.html",controller:"LoginController"}).when("/register",{templateUrl:"javascripts/login/register.html",controller:"RegisterController"})}]),angular.module("myApp").controller("ChatCtrl",["$scope","Restangular","$cookies","$location","$uibModal","webNotification","LoginService","dataFormat","socketService",function(a,b,c,d,e,f,g,h,i){var j,k=g.getUserData();a.onlineUsers=[],_.isEmpty(k)&&d.path("/login"),a.data={},a.toSend=[],a.data.name=k.nickName,i.reconnect(),i.emit("login",{userName:k.nickName}),i.on("chats",function(b){a.datas&&_.last(b)._id!=_.last(a.datas)._id&&_.last(b).name!=a.data.name&&l(_.last(b).name+": "+_.last(b).content),a.datas&&_.last(b)._id==_.last(a.datas)._id||(a.datas=h.format(b))}),i.on("chat_added",function(a){console.log("posted")}),i.on("user_login_change",function(b){a.onlineUsers=b});var l=function(a){f.showNotification("陈先森的院子有新消息!",{body:a,icon:"/images/favicon.ico",onClick:function(){console.log("Notification clicked.")},autoClose:4e3},function(a,b){a?window.alert("Unable to show notification: "+a.message):(console.log("Notification Shown."),setTimeout(function(){console.log("Hiding notification...."),b()},5e3))})},m=function(a){var b={};for(var c in a)b[c]="object"==typeof a[c]?deepCoyp(a[c]):a[c];return b};a.history=function(){e.open({templateUrl:"javascripts/chat/history.html",controller:"historyCtrl",size:"lg",backdrop:"static",resolve:{content:function(){return a.datas}}})},a.smsTest=function(){var b=new Date,c=b.getHours()+":"+b.getMinutes()+":"+b.getSeconds();a.data.date=c,j=m(a.data),a.data.content="",i.emit("add_new",{data:j})},a.$on("$locationChangeStart",function(a,b,c){i.disconnect()})}]),angular.module("myApp").controller("historyCtrl",["$scope","Restangular","$uibModalInstance","dataFormat","content",function(a,b,c,d,e){a.close=function(){c.dismiss()}}]),angular.module("myApp").controller("HomeController",["$scope","$location","LoginService",function(a,b,c){c.refresh(),a.user=c.getUserData(),_.isEmpty(a.user)||(a.logStatus=!0,b.path("/chat")),a.logout=function(){c.clearUserData(),a.logStatus=!1,b.path("/login")},a.$on("loginStatusChange",function(b,d){d&&(a.user=c.getUserData()),a.logStatus=d})}]),angular.module("myApp").controller("LoginController",["$scope","Restangular","$cookies","$location","LoginService",function(a,b,c,d,e){var f=e.getUserData();_.isEmpty(f)||d.path("/chat");var g=new Date;g.setDate(g.getDate()+30),a.doLogin=function(){b.one("/login").get(a.user).then(function(b){b.reqParams="",c.putObject("user",b,{expires:g.toUTCString()}),e.saveUserData(b),a.$emit("loginStatusChange",!0),d.path("/chat")},function(a){alert(a.data.message)})}}]),angular.module("myApp").controller("RegisterController",["$scope","Restangular","$cookies","$location","LoginService",function(a,b,c,d,e){var f=new Date;f.setDate(f.getDate()+30),a.doRegister=function(){return a.repass!=a.user.pass?void alert("两次密码输入不匹配"):void b.one("/").post("register",a.user).then(function(b){b.reqParams="",c.putObject("user",b,{expires:f.toUTCString()}),e.saveUserData(b),a.$emit("loginStatusChange",!0),d.path("/chat")},function(a){alert(a.data.message)})}}]),angular.module("dataFormat",[]).factory("dataFormat",[function(){var a={format:function(a){for(var b=a,c=0;c<b.length;c++){var d=b[c].name;for(c-=-1;c!=b.length;c++){if(b[c].name!=d){c-=1;break}b[c].hide=!0}}return b}};return a}]),angular.module("loginService",[]).factory("LoginService",["$cookies",function(a){var b={},c={saveUserData:function(a){return b.name=a.name,b.nickName=a.nick_name,b.role=a.role,b},getUserData:function(){return _.isEmpty(b)?{}:{name:b.name,nickName:b.nickName,role:b.role}},clearUserData:function(){b={},a.remove("user")},refresh:function(){return a.getObject("user")?c.saveUserData(a.getObject("user")):b={},b}};return c}]),angular.module("socketService",[]).factory("socketService",["$rootScope",function(a){var b=io.connect("http://115.28.109.109:81/");return{reconnect:function(){b.connected&&b.disconnect(),b=io.connect("http://115.28.109.109:81/")},on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})},disconnect:function(){b.disconnect()}}}]);