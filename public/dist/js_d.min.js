/*! <%= pkg.title || pkg.name %> - v<%= pkg.version %> - <%= grunt.template.today("yyyy-mm-dd") %>
<%= pkg.homepage ? "* " + pkg.homepage + "\n" : "" %>* Copyright (c) <%= grunt.template.today("yyyy") %> <%= pkg.author.name %>; Licensed <%= _.pluck(pkg.licenses, "type").join(", ") %> */
"use strict";angular.module("myApp",["ngRoute","loginService","restangular","ngCookies","angular-web-notification"]).config(["$locationProvider","$routeProvider",function(a,b){a.hashPrefix("!"),b.when("/",{redirectTo:"login"}).when("/chat",{templateUrl:"javascripts/chat/chat.html",controller:"ChatCtrl"}).when("/login",{templateUrl:"javascripts/login/login.html",controller:"LoginController"}).when("/register",{templateUrl:"javascripts/login/register.html",controller:"RegisterController"})}]),angular.module("myApp").controller("ChatCtrl",["$scope","Restangular","$cookies","$location","webNotification","LoginService",function(a,b,c,d,e,f){var g,h=!1,i=f.getUserData();_.isEmpty(i)&&d.path("/login"),a.data={},a.toSend=[],a.data.name=i.nickName;var j=setInterval(function(){k()},2e3),k=function(){h||(h=!0,b.one("/get_sms").get().then(function(b){a.datas&&_.last(b)._id!=_.last(a.datas)._id&&_.last(b).name!=a.data.name&&m(_.last(b).name+": "+_.last(b).content),a.datas&&_.last(b)._id==_.last(a.datas)._id||l(b),h=!1}))},l=function(b){for(var c=b,d=0;d<c.length;d++){var e=c[d].name;for(d-=-1;d!=c.length;d++){if(c[d].name!=e){d-=1;break}c[d].hide=!0}}a.datas=c},m=function(a){e.showNotification("陈先森的院子有新消息!",{body:a,icon:"/images/favicon.ico",onClick:function(){console.log("Notification clicked.")},autoClose:4e3},function(a,b){a?window.alert("Unable to show notification: "+a.message):(console.log("Notification Shown."),setTimeout(function(){console.log("Hiding notification...."),b()},5e3))})},n=function(a){var b={};for(var c in a)b[c]="object"==typeof a[c]?deepCoyp(a[c]):a[c];return b};a.smsTest=function(){var c=new Date,d=c.getHours()+":"+c.getMinutes()+":"+c.getSeconds();a.data.date=d,g=n(a.data),a.data.content="",a.toSend.push(g),a.datas.splice(0,1),a.datas[0].hide=!1,b.one("/").post("add_sms",g).then(function(b){a.toSend.splice(0,1),l(b)})},a.$on("$locationChangeStart",function(a,b,c){clearInterval(j)}),k()}]),angular.module("myApp").controller("HomeController",["$scope","$location","LoginService",function(a,b,c){c.refresh(),a.user=c.getUserData(),_.isEmpty(a.user)||(a.logStatus=!0,b.path("/chat")),a.logout=function(){c.clearUserData(),a.logStatus=!1,b.path("/login")},a.$on("loginStatusChange",function(b,d){d&&(a.user=c.getUserData()),a.logStatus=d})}]),angular.module("myApp").controller("LoginController",["$scope","Restangular","$cookies","$location","LoginService",function(a,b,c,d,e){var f=e.getUserData();_.isEmpty(f)||d.path("/chat");var g=new Date;g.setDate(g.getDate()+30),a.doLogin=function(){b.one("/login").get(a.user).then(function(b){b.reqParams="",c.putObject("user",b,{expires:g.toUTCString()}),e.saveUserData(b),a.$emit("loginStatusChange",!0),d.path("/chat")},function(a){alert(a.data.message)})}}]),angular.module("myApp").controller("RegisterController",["$scope","Restangular","$cookies","$location","LoginService",function(a,b,c,d,e){var f=new Date;f.setDate(f.getDate()+30),a.doRegister=function(){return a.repass!=a.user.pass?void alert("两次密码输入不匹配"):void b.one("/").post("register",a.user).then(function(b){b.reqParams="",c.putObject("user",b,{expires:f.toUTCString()}),e.saveUserData(b),a.$emit("loginStatusChange",!0),d.path("/chat")},function(a){alert(a.data.message)})}}]),angular.module("loginService",[]).factory("LoginService",["$cookies",function(a){var b={},c={saveUserData:function(a){return b.name=a.name,b.nickName=a.nick_name,b.role=a.role,b},getUserData:function(){return _.isEmpty(b)?{}:{name:b.name,nickName:b.nickName,role:b.role}},clearUserData:function(){b={},a.remove("user")},refresh:function(){return a.getObject("user")?c.saveUserData(a.getObject("user")):b={},b}};return c}]);